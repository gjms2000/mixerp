<script src="/Scripts/inflection-js/inflection.js"></script>
<style>
    .kanban.container {
        overflow-y: hidden;
        overflow-x: auto;
    }


    .kanban.segments .ui.segment {
        max-width: 300px !important;
        min-height: 700px;
        padding: 8px;
    }

    .kanban .card {
        cursor: pointer;
    }

    .kanban.segments .ui.segment:nth-child(odd) {
        background-color: #FAFAFA !important;
    }

    .kanban.segments .ui.segment:nth-child(even) {
        background-color: #F9F9F9 !important;
    }

    .kanban.holder {
        height: 100%;
    }
</style>

<div class="view factory">

    <div id="VerificationPopUnder" class="ui initially hidden form popunder segment" style="width:400px;z-index:3; position: absolute;">
        <div class="ui header">Verification</div>
        <div class="field">
            <label>Reason</label>
            <textarea id="ReasonTextArea"></textarea>
        </div>
        <div class="ui buttons">
            <a id="ApproveButton" class="ui green button" href="javascript:void(0);">Approve</a>
            <a id="RejectButton" class="ui orange button" href="javascript:void(0);">Reject</a>
            <input onclick="$('#VerificationPopUnder').fadeOut(500);" class="ui red button" value="Close" type="button">
        </div>
    </div>

    <div id="FlagPopUnder" class="ui initially hidden form popunder segment" style="width:400px;z-index:3; position: absolute;">
        <div class="ui grey header">Create a Flag</div>
        <div>You can mark this item with a flag, however you will not be able to see the flags created by other users.</div>
        <p>Select a flag.</p>

        <select id="FlagSelect" class="ui fluid search dropdown selection"></select>

        <p class="ui buttons tpad8">
            <input id="UpdateButton" value="Update" class="green small ui button" type="button" />
            <input onclick="$('#FlagPopUnder').fadeOut(500);" class="red small ui button" value="Close" type="button">
        </p>
    </div>

    <div id="FilterPopUnder" class="ui initially hidden form popunder segment" style="width:400px;z-index:3; position: absolute;">
        <div class="ui grey header">Select a Filter</div>
        <select class="ui fluid filter" id="DefaultFilterSelect"></select>
        <p class="ui action buttons tpad8">
            <a href="javascript:void(0);" onclick="$('#FilterPopUnder').fadeOut(500);" class="green small ui button" data-target="filter">Create New</a>
            <input onclick="$('#FilterPopUnder').fadeOut(500);" class="red small ui button" value="Close" type="button">
        </p>
    </div>



    <div class="ui stackable grid">
        <div class="ui left floated ten wide column">
            <div class="title ui huge grey header"></div>
            <div id="description" style="display: none;"></div>
        </div>
        <div class="ui right floated six wide column">
        </div>
    </div>




    <script src="/Scripts/underscore/underscore-min.js"></script>

    <div id="KanbanForm" class="ui small modal">
        <i class="close icon"></i>
        <div class="ui grey header">
            Add a Kanban List
        </div>
        <div class="content">
            <div class="ui form">
                <div class="field">
                    <label>Kanban Id</label>
                    <input type="text" readonly id="KanbanIdInputText" />
                </div>
                <div class="field">
                    <label>Kanban Name</label>
                    <input type="text" id="KanbanNameInputText" />
                </div>
                <div class="field">
                    <label>Description</label>
                    <textarea id="KanbanDescriptionTextArea"></textarea>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui basic buttons">
                <div class="ui cancel button">Cancel</div>
                <a href="javascript:void(0);" class="ui button" onclick="saveOrUpdateKanban();">OK</a>
            </div>
        </div>
    </div>

    <div class="ui stackable grid">
        <div class="twelve wide column">
            <div class="ui basic buttons">
                <a id="AddNewButton" class="ui basic button">
                    Add New
                </a>
                <a id="FlagButton" class="ui basic button">
                    Flag
                </a>
                <a class="ui basic button" id="FilterButton">
                    Filter
                </a>
                <div class="ui icon top left pointing dropdown basic button" id="ExportDropDown">
                    <span>Export</span>
                    <div class="menu">
                        <div class="header">
                            Export This Document
                        </div>
                        <a class="item" href="javascript:void(0);" onclick="createDoc();">
                            <i class="file word outline blue icon"></i>
                            To Word Document
                        </a>
                        <a class="item" href="javascript:void(0);" onclick="createXls();">
                            <i class="file excel outline green icon"></i>
                            To Excel Document
                        </a>
                        <a class="item" href="javascript:void(0);" onclick="createPDF();">
                            <i class="file pdf outline red icon"></i>
                            To PDF Document
                        </a>
                    </div>
                </div>
                <a id="PrintButton" href="javascript:void(0);" onclick="print()" class="ui basic button">
                    Print
                </a>
            </div>
        </div>
        <div class="right aligned four wide column">
            <div class="ui small basic icon action buttons">
                <a class="ui basic button" data-target="import" title="Import">
                    <i class="upload layout icon"></i>
                </a>
                <a class="ui basic button" data-target="filter" title="Manage Filters">
                    <i class="icons">
                        <i class="filter layout icon"></i>
                        <i class="corner add icon"></i>
                    </i>
                </a>
                <a class="ui basic button" data-target="kanban" title="Kanban View">
                    <i class="block layout icon"></i>
                </a>
                <a class="ui active basic button" data-target="view" title="Grid View">
                    <i class="grid layout icon"></i>
                </a>
            </div>
        </div>
    </div>
    <div class="ui segment" data-target="view">
        <div id="json" class="vpad8" style="width: 100%; overflow: auto;">
        </div>
        <div class="ui divider"></div>
        <div class="ui stackable grid">
            <div class="left aligned six wide column">
                <div class="ui breadcrumb">
                    <a class="section" id="CurrentPageAnchor"></a>
                    <div class="divider">/ </div>
                    <a class="section" id="TotalPagesAnchor"></a>
                </div>
            </div>
            <div class="right aligned ten wide column">
                <a class="ui left attached labeled icon button" id="PreviousButton"><i class="left arrow icon"></i>Previous</a>
                <a class="ui right attached right labeled icon button" id="NextButton">Next<i class="right arrow icon"></i></a>
            </div>
        </div>
    </div>

    <div data-target="kanban" style="display: none;">
        <div class="kanban container">
            <div class="ui horizontal kanban segments" id="kanban" style="display: none;">

            </div>
        </div>
    </div>

    <div class="ui bottom hidden segment" data-target="filter">
        <div class="ui huge header">
            Filter:
            <span id="FilterName">
            </span>
        </div>
        <div class="ui divider"></div>

        <div class="ui stackable form" id="FilterForm">
            <div class="five fields">
                <div class="field">
                    <label>Select a Column</label>
                    <select class="ui search dropdown" id="ColumnSelect" required></select>
                </div>
                <div class="field">
                    <label>Filter Condition</label>
                    <select class="ui search dropdown" id="FilterConditionSelect" required></select>
                </div>
                <div class="field">
                    <label>Value</label>
                    <input id="ValueInputText" required />
                </div>
                <div class="field">
                    <label>And</label>
                    <input id="AndInputText" readonly="readonly" />
                </div>
                <div class="field">
                    <label>&nbsp;</label>
                    <input class="ui button" id="AddFilterButton" type="button" value="Add">
                </div>
            </div>
        </div>

        <table class="ui striped table" id="FilterTable">
            <thead>
                <tr>
                    <th style="width: 100px;">Actions</th>
                    <th>Column Name</th>
                    <th>Condition</th>
                    <th>Value</th>
                    <th>And</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="ui large header">Save this Filter</div>
        <div class="ui divider"></div>
        <div class="ui form">
            <div class="fields">
                <div class="four wide field">
                    <label>Filter Name</label>
                    <input id="FilterNameInputText" />
                </div>
            </div>
            <div class="ui basic buttons">
                <div class="ui basic button" id="SaveFilterButton">Save</div>
                <div class="ui basic button" id="ManageFiltersButton">Manage Filters</div>
                <div class="ui basic button">Cancel</div>
            </div>
        </div>

        <div class="ui filter small modal">
            <i class="close icon"></i>
            <div class="ui huge header">
                Manage Filters
            </div>
            <div class="content">
                <div class="ui form" style="max-width: 400px;">
                    <div class="field">
                        <label>Select a Filter</label>
                        <select class="ui search dropdown filter" id="FilterSelect"></select>
                    </div>
                    <div class="ui basic buttons">
                        <a class="ui close button" onclick="loadFilter();">Edit</a>
                        <a class="ui close button" onclick="loadFilter();">Delete</a>
                        <a class="ui close button">Close</a>
                    </div>

                </div>
            </div>
            <div class="actions">
                <div class="ui basic buttons">
                    <a class="ui basic close button">Remove User Defaults</a>
                    <a class="ui basic button" id="MakeUserDefaultFilterButton">Default (For Users)</a>
                </div>
            </div>
        </div>
    </div>

    <div class="ui hidden segment" data-target="import">
        <div class="ui huge header">Data Import</div>

        <div class="ui basic buttons">
            <a class="ui basic button" id="DownloadTemplateButton">Export Data</a>
            <div class="ui basic button">
                <label for="file">Import Data</label>
                <input type="file" id="file" style="display:none;">
            </div>
        </div>

        <div class="big error"></div>

        <div id="ProgressBar" class="vpad16" style="display:none;">
            <div data-percent="0" class="ui indicating progress active">
                <div style="transition-duration: 300ms; width: 0%;" class="bar"></div>
                <div class="label"></div>
            </div>
        </div>
    </div>















    <br />
    <script>
        var json;
        var kanbans;
        var form = $(".form.factory");
        var view = $(".view.factory");
        var metaDefinition;
        var falgDefinition;

        $("#AddNewButton").click(function () {
            if (form.length) {
                view.hide();
                form.fadeIn(500);
                var url = updateQueryString("View", "FormView");
                window.history.pushState({ path: url }, '', url);
            };
        });


        if (!scrudFactory.card) {
            scrudFactory.card = new Object();
        };
    </script>

    <script>
        var columns = [];
        var filterConditions = [{ "value": "0", "text": "IsEqualTo" },
        { "value": "1", "text": "IsNotEqualTo" },
        { "value": "2", "text": "IsLessThan" },
        { "value": "3", "text": "IsLessThanEqualTo" },
        { "value": "4", "text": "IsGreaterThan" },
        { "value": "5", "text": "IsGreaterThanEqualTo" },
        { "value": "6", "text": "IsBetween" },
        { "value": "7", "text": "IsNotBetween" },
        { "value": "8", "text": "IsLike" },
        { "value": "9", "text": "IsNotLike" }];

        $("#FilterName").text(Resources.Titles.Untitled());
    </script>
    <script>
        function tryParseLocalizedResource(text) {
            var localized = executeFunctionByName("Resources.Titles." + text, window);

            if (!localized) {
                localized = executeFunctionByName("Resources.ScrudResource." + text, window);
            };

            if (localized) {
                return localized;
            };

            return text;
        };

        function toUnderscoreCase(str) {
            return str.replace(/(?:^|\.?)([A-Z])/g, function (x, y) { return "_" + y.toLowerCase() }).replace(/^_/, "");
        };

        function localizeHeaders(el) {
            el.find("thead tr th").each(function () {
                var cell = $(this);

                var name = toUnderscoreCase(cell.text());
                var text = tryParseLocalizedResource(name);
                cell.text(text);

                var column = new Object();
                column.name = name;
                column.text = text;

                columns.push(column);
            });
        };
    </script>
    <script>
        function createGridView(appendTo, json) {
            appendTo.html("");

            if (isNullOrWhiteSpace(json || "")) {
                return;
            };
            var excludedColumnIndices = [];

            if (!json) {
                return null;
            };

            var el = $('<table class="ui striped nowrap definition table" id="ScrudView">');
            var header = "<thead><tr>";

            var index = 0;

            $.each(json[0], function (name) {
                if (scrudFactory.excludedColumns.indexOf(name) === -1) {
                    header += "<th>" + name + "</th>";
                } else {
                    excludedColumnIndices.push(index);
                };

                index++;
            });

            header += "</tr></thead>";

            $(header).appendTo(el);

            var body = $("<tbody />");

            $.each(json, function (i, value) {
                var row = "<tr>";

                index = 0;
                $.each(value, function (key, val) {
                    if (excludedColumnIndices.indexOf(index) === -1) {
                        var title = "";
                        if (val === false) {
                            val = Resources.Titles.No();
                        };

                        if (val === true) {
                            val = Resources.Titles.Yes();
                        };

                        var column = Enumerable.From(metaDefinition.Columns)
                            .Where(function (x) { return x.PropertyName === key }).ToArray()[0];

                        if (column) {
                            var dataType = column.DbDataType;

                            if (dataType === "date") {
                                if (val == null) {
                                    val = "";
                                };

                                title = ' title ="' + val.toFormattedDate() + '"';
                                var d = new Date(removeTimezone(val));
                                val = moment(d).fromNow();
                            };

                            if (dataType === "time") {
                                val = getTime(val);
                            };
                        };

                        row += stringFormat("<td{0}>{1}</td>", title, (val || ""));
                    };

                    index++;
                });

                row += "</tr>";

                body.append(row);
            });

            $(el).append(body);
            $(appendTo).append(el);
        };

    </script>
    <script>
        //Utilities
        function getPageNumber() {
            var page = parseInt(getQueryStringByName("Page") || 0);
            var totalPage = parseInt($("#TotalPagesAnchor").text() || 1);

            if (!page) {
                return 1;
            };

            if (page > totalPage) {
                page = totalPage;
            };

            return page;
        };

        function getFilter() {
            if ($("#DefaultFilterSelect").val()) {
                var filter = $("#DefaultFilterSelect").getSelectedValue();
                return filter;
            };

            return "";
        };


        function bindSelect(el, data, valueField, textField) {
            $.each(data, function () {
                var option = "<option value='" + this[valueField] + "'>" + this[textField] + "</option>";
                el.append(option);
            });
        };
    </script>
    <script>
        function loadPageCount(callback) {
            $("div[data-target=view]").append('<div class="ui active large inline loader"></div>');
            var filterName = getFilter();

            var getTotalPagesAjax = getTotalPages(filterName, false);

            getTotalPagesAjax.success(function (msg) {
                var pages = parseInt(msg || 1);

                $("#TotalPagesAnchor").text(pages);

                if (typeof callback === "function") {
                    callback();
                };
            });

            getTotalPagesAjax.fail(function (xhr) {
                logAjaxErrorMessage(xhr);
            });

        };

        function getTotalPages(filterName) {
            if (getFilterQueryStringCount()) {
                var qs = getQueryStrings();
                return getFilteredTotalPages(qs);
            };

            var url = scrudFactory.viewAPI + "/count";

            if (filterName) {
                url = scrudFactory.viewAPI + "/count-filtered/" + filterName;
            }

            return getAjaxRequest(url);
        };

        function getAjaxFilters(queryStrings) {
            var filters = [];

            $.each(queryStrings, function (index, value) {
                filters.push(getAjaxColumnFilter("WHERE", toUnderscoreCase(value.key), 0, value.value));
            });

            return filters;
        };

        function getFilteredTotalPages(queryStrings) {
            var filters = getAjaxFilters(queryStrings);

            var url = scrudFactory.viewAPI + "/count-where";
            var data = JSON.stringify(filters);

            return getAjaxRequest(url, "POST", data);
        };


    </script>
    <script>
        function loadFilterConditions() {
            var el = $("#FilterConditionSelect");
            bindSelect(el, filterConditions, "value", "text");
            el.dropdown();
        };

        function loadColumns() {
            var el = $("#ColumnSelect");
            el.html("");
            bindSelect(el, columns, "name", "text");
            el.dropdown();
        };

        $("#FilterNameInputText").keyup(function () {
            $("#FilterName").html($(this).val() || Resources.Titles.Untitled());
        });

        function loadFilter() {
            var filterName = $("#FilterSelect").getSelectedText();
            $("#FilterName").html(filterName);
            $("#FilterNameInputText").val(filterName);
            var getFiltersAjax = getFilters(filterName);

            getFiltersAjax.success(function (msg) {
                createFilters(msg);
                $('.filter.modal').modal('hide');
            });

            getFiltersAjax.fail(function (xhr) {
                logAjaxErrorMessage(xhr);
            });
        };

        function getFilters(filterName) {
            var url = "/api/core/filter/get-where/1";
            var where = [];

            where.push(getAjaxColumnFilter("WHERE", "object_name", FilterConditions.IsEqualTo, scrudFactory.viewTableName));
            where.push(getAjaxColumnFilter("AND", "filter_name", FilterConditions.IsEqualTo, filterName));

            var data = JSON.stringify(where);

            return getAjaxRequest(url, "POST", data, true);
        };
    </script>
    <script>
        function loadFilterNames() {
            var getFilterNamesAjax = getFilterNames();

            getFilterNamesAjax.success(function (data) {
                var selected = "";

                var option = "<option value=''>Select a Filter</option>";

                $.each(data, function () {
                    var isDefault = this.IsDefault;

                    if (isDefault) {
                        selected = this.FilterName;
                    };

                    option += stringFormat("<option value='{0}'>{0}</option>", this.FilterName);
                });


                $("#DefaultFilterSelect").html(option);

                if (selected) {
                    $("#DefaultFilterSelect").dropdown({ placeholder: false }).dropdown("set selected", selected);
                    loadPageCount(loadGrid);
                } else {
                    $("#DefaultFilterSelect").dropdown({ placeholder: false });
                    loadPageCount(loadGrid);
                };

                $("#FilterSelect").html(option).dropdown();


                $("#DefaultFilterSelect").change(function () {
                    loadPageCount(loadGrid);
                });
            });
        };

        function getFilterNames() {
            var url = "/api/core/filter-name-view/get-where/1";
            var where = [];

            where.push(getAjaxColumnFilter("WHERE", "object_name", FilterConditions.IsEqualTo, scrudFactory.viewTableName));
            var data = JSON.stringify(where);

            return getAjaxRequest(url, "POST", data, false);
        };
    </script>
    <script>
    </script>
    <script>
        $(document).ready(function () {
            var form = $(".form.factory");
            var view = $(".view.factory");

            var defaultView = window.getQueryStringByName("View");

            if ((defaultView || "") === "FormView") {
                view.hide();
                form.fadeIn(500);
            } else {
                form.hide();
            };


            loadMeta(loadFilterNames);
            loadFilterConditions();
            $("#ExportDropDown").dropdown();

            if (scrudFactory.title) {
                $(".title").html(scrudFactory.title);
            };
            if (scrudFactory.description) {
                $("#description").html(scrudFactory.description).show();
            } else {
                $("#description").remove();
            };

            if (typeof (scrudFactory.back) === "object") {
                var title = scrudFactory.back.Title;
                var url = scrudFactory.back.Url;

                var anchor = $("<a/>");
                anchor.addClass("ui basic button");
                anchor.attr("title", Resources.Titles.Back());
                anchor.attr("href", url);
                anchor.text(title);

                $("#AddNewButton").before(anchor);
            };
        });

        function loadMeta(callback) {
            var getMetaAjax = getMeta();

            getMetaAjax.success(function (msg) {
                metaDefinition = msg;
                createVerification();
                if (typeof (callback) === "function") {
                    callback();
                }
            });
        };


        function loadGrid() {
            var pageNumber = getPageNumber();
            var filterName = getFilter();
            $("#CurrentPageAnchor").text(pageNumber);


            var getViewAjax = getView(pageNumber, filterName, false);

            getViewAjax.success(function (response) {
                window.json = response;
                var el = $("#json");
                createGridView(el, window.json);
                localizeHeaders(el);
                loadColumns();
                loadActions();
                $(document).trigger("viewready");
                $("[data-target=view] .loader").remove();
                createCards();
            });

            getViewAjax.fail(function (xhr) {
                logAjaxErrorMessage(xhr);
            });
        };

        function getFilterQueryStringCount() {
            var qs = getQueryStrings();
            var ignoredQueryStrings = ["View", "Page"];
            var count = Enumerable.From(qs).Where(function (s) { return ignoredQueryStrings.indexOf(s.key) === -1; }).ToArray().length;

            return count;
        };

        function getView(pageNumber, filterName, byOffice) {
            if (getFilterQueryStringCount()) {
                var qs = getQueryStrings();
                return getFilteredView(pageNumber, qs, byOffice);
            };

            var url = scrudFactory.viewAPI + "/page/" + pageNumber;

            if (filterName) {
                url = scrudFactory.viewAPI + "/get-filtered/" + pageNumber + "/" + filterName;
            };

            return getAjaxRequest(url);
        };

        function getFilteredView(pageNumber, queryStrings) {
            var url = scrudFactory.viewAPI + "/get-where/" + pageNumber;
            data = JSON.stringify(getAjaxFilters(queryStrings));
            return getAjaxRequest(url, "POST", data);
        };

        function getMeta() {
            var url = scrudFactory.formAPI + "/meta";
            return getAjaxRequest(url);
        };
    </script>
    <script>
        var columnSelect = $("#ColumnSelect");
        var filterConditionSelect = $("#FilterConditionSelect");
        var valueInputText = $("#ValueInputText");
        var andInputText = $("#AndInputText");
        var commandItems = "<a onclick='deleteFilter(this);'><i class='delete icon'></i></a><a onclick='editFilter(this);'><i class='edit icon'></i></a><a onclick='$(this).parent().parent().toggleClass(\"warning\");'><i class='check mark icon'></i></a>";



        filterConditionSelect.change(function () {
            var val = parseFloat(filterConditionSelect.val() || 0);

            if (val >= 6 && val <= 7) {
                andInputText.removeAttr("readonly");
                return;
            };

            andInputText.attr("readonly", "readonly");
            andInputText.val("");
        });

        function validateFilters() {
            var isValid = true;

            $("#FilterForm [required]").each(function () {
                var el = $(this);

                if (isNullOrWhiteSpace(el.val())) {
                    isValid = false;
                    makeDirty(el);
                    return;
                };

                removeDirty(el);
            });

            return isValid;
        };


        $("#AddFilterButton").click(function () {
            var grid = $("#FilterTable");

            var isValid = validateFilters();
            if (!isValid) {
                return;
            };

            var selectedColumn = columnSelect.getSelectedText();
            var filterCondition = filterConditionSelect.getSelectedText();

            var value = valueInputText.val();
            var and = andInputText.val();

            var duplicate = false;

            grid.find("tbody tr").each(function () {
                var el = $(this);
                var columnName = el.find("td:nth-child(2)").text();
                var condition = el.find("td:nth-child(3)").text();

                if (columnName === selectedColumn &&
                    condition === filterCondition) {

                    el.find("td:nth-child(4)").text(value);
                    el.find("td:nth-child(5)").text(and);

                    el.addClass("warning");
                    duplicate = true;
                    return false;
                };
            });


            if (!duplicate) {
                addFilterRow(selectedColumn, filterCondition, value, and);
            };
        });


        function addFilterRow(selectedColumn, filterCondition, value, and, css) {
            var html = "<tr>";
            html += "<td>" + commandItems + "</td>";
            html += "<td>" + selectedColumn + "</td>";
            html += "<td>" + filterCondition + "</td>";
            html += "<td>" + value + "</td>";
            html += "<td>" + and + "</td>";
            html += "</tr>";

            var row = $(html);

            if (css) {
                row.addClass(css);
            };

            $("#FilterTable").removeClass("inverted red").find("tbody").append(row);
            columnSelect.parent().find(".search").focus();
        };

        $("#ManageFiltersButton").click(function () {
            $('.filter.modal').modal('show');
        });

        $("#SaveFilterButton").click(function () {
            var table = $("#FilterTable");
            var filterNameInputText = $("#FilterNameInputText");

            if (isNullOrWhiteSpace(filterNameInputText.val())) {
                makeDirty(filterNameInputText);
                return;
            };

            removeDirty(filterNameInputText);

            if (!table.find("tbody tr").length) {
                table.addClass("inverted red");
                return;
            };

            table.removeClass("inverted red");

            var error = table.find("tr.error td:nth-child(2)").text();

            if (error.length) {
                var message = "The column \"{0}\" is invalid and does not exist. Are you sure you want to continue?";

                var confirmed = confirm(stringFormat(message, error));
                if (!confirmed) {
                    return;
                };
            };

            var filters = [];

            $("#FilterTable tbody tr").each(function () {
                var el = $(this);
                var columnName = el.find("td:nth-child(2)").text();
                var condition = el.find("td:nth-child(3)").text();

                var filter = new Object();

                filter.FilterId = window.filterId;
                filter.FilterStatement = "AND";
                filter.ObjectName = scrudFactory.viewTableName;
                filter.FilterName = filterNameInputText.val();

                filter.ColumnName = Enumerable.From(columns)
                    .Where(function (x) { return x.text === columnName }).ToArray()[0].name;

                filter.FilterCondition = parseInt(
                                            Enumerable.From(filterConditions)
                                            .Where(function (x) { return x.text === condition })
                                             .ToArray()[0].value
                                         || 0);

                filter.FilterValue = el.find("td:nth-child(4)").text();
                filter.FilterAndValue = el.find("td:nth-child(5)").text();
                filters.push(filter);
            });

            var saveFilterAjax = saveFilter(filterNameInputText.val(), filters);

            saveFilterAjax.success(function () {
                window.filterId = 0;
                displayMessage(Resources.Titles.TaskCompletedSuccessfully(), "success");
            });

            saveFilterAjax.fail(function (xhr) {
                logAjaxErrorMessage(xhr);
            });
        });

        function saveFilter(filterName, filters) {
            var url = "/api/core/filter/recreate/" + scrudFactory.viewTableName + "/" + filterName;
            var data = JSON.stringify(filters);

            return getAjaxRequest(url, "PUT", data);
        };


        function createFilters(filters) {
            $("#FilterTable").find("tbody").html("");
            $.each(filters, function (i, filter) {

                var selectedColumn = filter.ColumnName;
                var filterCondition = filter.FilterCondition;
                var value = filter.FilterValue;
                var and = (filter.FilterAndValue || "");

                var css = "";

                filterCondition = Enumerable.From(filterConditions)
                    .Where(function (x) { return x.value === filterCondition.toString() })
                    .Select(function (x) { return x.text }).ToArray()[0];

                column = Enumerable.From(columns)
                    .Where(function (x) { return x.name === selectedColumn }).ToArray()[0];

                if (column) {
                    selectedColumn = column.text;
                } else {
                    css = "error";
                };

                addFilterRow(selectedColumn, filterCondition, value, and, css);
            });
        };

        function deleteFilter(el) {
            if (confirmAction()) {
                $(el).parent().parent().remove();
            };

        };

    </script>

    <script>
        $("#MakeUserDefaultFilterButton").click(function () {
            var filterName = $("#FilterSelect").getSelectedText();
            var makeDefaultFilterAjax = makeDefaultFilter(filterName);

            makeDefaultFilterAjax.success(function () {
                displayMessage(Resources.Labels.TaskCompletedSuccessfully(), "success");

                $(".filter.modal").modal("close");
            });

            makeDefaultFilterAjax.fail(function (xhr) {
                logAjaxErrorMessage(xhr);
            });
        });

        function makeDefaultFilter(filterName) {
            var url = "/api/core/filter/make-default/" + scrudFactory.viewTableName + "/" + filterName;
            return getAjaxRequest(url, "PUT");
        };

    </script>

    <script>
        function changeTab(el) {
            el = $(el);
            var tab = el.attr("data-target");

            $.tab('change tab', tab);

            el.parent().find(".active.item").removeClass("active");
            el.addClass("active");
        };

        function setPageNumber(pageNumber) {
            var url = updateQueryString("Page", pageNumber);
            window.history.pushState({ path: url }, '', url);
        };

        $("#NextButton").click(function () {
            var totalPage = parseInt($("#TotalPagesAnchor").text() || 1);
            var nextPage = getPageNumber() + 1;

            if (nextPage > totalPage) {
                nextPage = totalPage;
            };

            setPageNumber(nextPage);

            loadPageCount(loadGrid);
        });


        $("#PreviousButton").click(function () {
            var previousPage = getPageNumber() - 1;

            if (previousPage < 1) {
                previousPage = 1;
            };

            setPageNumber(previousPage);

            loadPageCount(loadGrid);
        });
    </script>
    <script>
        $("#DownloadTemplateButton").click(function () {
            var downloadTemplateAjax = downloadTemplate();
            var el = this;

            if (!el.href) {
                $(el).addClass("loading");

                downloadTemplateAjax.success(function (json) {
                    var csv = jsonToCsv(json);
                    var uri = 'data:text/csv;charset=utf-8,' + escape(csv);
                    el.href = uri;
                    el.target = "_blank";
                    el.download = scrudFactory.title + ".csv";

                    $(el).removeClass("loading");

                    el.click();
                });

                downloadTemplateAjax.fail(function () {
                    $(el).removeClass("loading");
                });
            };
        });

        function jsonToCsv(json) {

            var header = "";
            var rows = "";

            $.each(json[0], function (name) {
                if (header) {
                    header += ",";
                };

                header += '"' + name.replace(/"/g, '""') + '"';
            });

            header += "\r\n";

            $.each(json, function (i, value) {
                var row = "";

                $.each(value, function (key, val) {
                    if (row) {
                        row += ",";
                    };

                    if (val == null) {
                        row += '""';
                    }
                    else {
                        row += '"' + val.toString().replace(/"/g, '""') + '"';
                    };
                });

                row += "\r\n";
                rows += row;
            });

            var csv = header + rows;
            return csv;
        };


        function toProperCase(str) {
            var result = str.replace(/_([a-z])/g, function (g) { return g[1].toUpperCase(); });
            return result.charAt(0).toUpperCase() + result.slice(1);
        };


        function downloadTemplate() {
            var url = scrudFactory.formAPI + "/export";
            return getAjaxRequest(url);
        };

        function bulkImport(entities) {
            var url = scrudFactory.formAPI + "/bulk-import";
            var data = JSON.stringify(entities);
            return getAjaxRequest(url, "PUT", data);
        };
    </script>
    <script>
        $("#file").change(function () {
            var el = $(this);
            $(".big.error").removeClass("vpad8").html("");
            var file = this.files[0];

            if (!file) {
                return;
            };

            var supportedFileTypes = ["text/csv", "application/csv"];

            if (supportedFileTypes.indexOf(file.type) === -1) {
                $(".big.error").addClass("vpad8").html(stringFormat("Your upload is of invalid file type \"{0}\". Please try again.", file.type));
                return;
            };

            $("#ProgressBar").show();
            var progress = $(".progress");

            showProgress(progress, 25, "Processing  your CSV file");

            var reader = new FileReader();

            reader.onload = function () {
                var result = reader.result;
                showProgress(progress, 50, "Successfully processed your file.");
                var entities = Papa.parse(result, { "header": true, skipEmptyLines: true }).data;

                showProgress(progress, 50, "Requesting import. This may take several minutes to complete.");

                el.closest(".segment").find(".button").addClass("loading");

                var bulkImportAjax = bulkImport(entities);

                bulkImportAjax.success(function () {
                    var message = stringFormat("Successfully imported {0} items.", entities.length);
                    showProgress(progress, 100, message);
                    el.closest(".segment").find(".button").removeClass("loading");
                });

                bulkImportAjax.fail(function (xhr) {
                    $(".big.error").addClass("vpad8").html(getAjaxErrorMessage(xhr));
                    el.closest(".segment").find(".button").removeClass("loading");
                    showProgress(progress, 0, "Rolling back changes.");
                    $("#ProgressBar").fadeOut(2000);
                });
            };

            reader.readAsText(file);

        });

        function showProgress(el, percentage, message) {
            el.attr("data-percent", percentage.toString());
            el.find(".bar").css("width", percentage.toString() + "%");
            el.find(".label").text(percentage.toString() + "% - " + message);
        };
    </script>
    <script>
        function loadActions() {
            var deleteTemplate = "";
            var editTemplate = "";

            if (scrudFactory.allowDelete) {
                deleteTemplate = stringFormat("<a onclick='deleteRow(this);' title='{0}'><i class='delete icon'></i></a>", Resources.Titles.Delete());
            };

            if (scrudFactory.allowEdit) {
                editTemplate = stringFormat("<a onclick='editRow(this);' title='{0}'><i class='edit icon'></i></a>", Resources.Titles.Edit());
            };

            var grid = $(".definition.table");
            var header = stringFormat("<th style='width:{0}px;'></th>", 25 * (!isNullOrWhiteSpace(editTemplate) + !isNullOrWhiteSpace(deleteTemplate)));
            header += "<th class='action' style='cursor:pointer;'>" + Resources.Titles.Select() + "</th>";
            var selectTemplate = '<div class="ui toggle checkbox"> \
                                      <input type="checkbox">\
                                      <label></label>\
                                    </div>';

            var column = stringFormat("<td>{0}{1}</td><td>{2}</td>", editTemplate, deleteTemplate, selectTemplate);

            grid.find("th:first-child").before(header);
            grid.find("td:first-child").before(column);

            $(".definition.table tr").click(function (sender) {
                var row = $(this);
                var cell = $(sender.target).closest('td');

                if (cell.index() > 1) {
                    var el = row.find("input:checkbox");
                    toogleSelection(el);
                };
            });

            var isSelectionToggler = true;

            $("th.action").click(function () {
                if (isSelectionToggler) {
                    $(".definition.table input:checkbox").prop("checked", "checked");
                }
                else {
                    $(".definition.table input:checkbox").removeProp("checked");
                };

                isSelectionToggler = !isSelectionToggler;
            });
        };

    </script>
    <script>
        function deleteRow(el, isCard) {
            var confirmed = confirmAction();

            if (!confirmed) {
                return;
            };

            var primaryKeyValue = getPrimaryKeyValue($(el), isCard);

            var deleteAjax = deleteEntity(primaryKeyValue);

            deleteAjax.success(function () {
                var confirmed = confirm("Task completed successfully. Refresh view?");

                if (confirmed) {
                    loadPageCount(loadGrid);
                };
            });
        };

        function getKeyColumnPosition() {
            if (typeof (scrudFactory.keyColumnPosition) === "undefined") {
                scrudFactory.keyColumnPosition = "3";
            };

            return scrudFactory.keyColumnPosition;
        };

        function getPrimaryKeyValue(sender, isCard) {
            if (isCard) {
                var card = sender.closest(".card");
                return card.attr("data-key");
            };


            var selector = "td:nth-child(" + getKeyColumnPosition() + ")";
            var primaryKeyValue = sender.parent().parent().find(selector).text();
            return primaryKeyValue;
        };

        function editRow(el, isCard) {
            var confirmed = confirmAction();

            if (!confirmed) {
                return;
            };

            if (window.form === "undefined") {
                alert("No instance of form handler was found.");
                return;
            };

            var primaryKeyValue = getPrimaryKeyValue($(el), isCard);

            var tableName = scrudFactory.formTableName;

            var getViewForEditAjax = getViewForEdit(primaryKeyValue);

            getViewForEditAjax.success(function (data) {
                displayEdit(data, false);

                getCustomFieldsForEdit(tableName, primaryKeyValue).success(function (msg) {
                    displayCustomFields(msg);
                    view.hide();
                    form.fadeIn(500);
                });
            });
        };



        function displayEdit(items) {
            for (var id in items) {
                var value = items[id];
                if (value) {
                    editFormElement(toUnderscoreCase(id), value);
                };
            };
        };

        function displayCustomFields(items) {
            $.each(items, function (i, v) {
                var id = v.FieldName;
                var value = v.Value;

                editFormElement(id, value);
            });
        };

        function editFormElement(id, value) {
            var targetEl = $("#" + id);

            if (targetEl.length) {
                if (targetEl.hasClass("date")) {
                    value = value.toFormattedDate();
                };

                if (targetEl.attr("data-type") === "time") {
                    value = getTime(value);
                };

                targetEl.val(value);

                if (targetEl.is("select")) {
                    var type = targetEl.attr("data-type");

                    if (type === "bool") {
                        value = value ? "yes" : "no";
                    };

                    targetEl.dropdown("set selected", value);
                    targetEl.trigger("blur");
                    targetEl.trigger("change");
                };
            };
        };
    </script>
    <script>

        function deleteEntity(primaryKeyValue) {
            var url = scrudFactory.formAPI + "/delete/" + primaryKeyValue;
            return getAjaxRequest(url, "DELETE");
        };

        function getViewForEdit(primaryKeyValue) {
            var url = scrudFactory.formAPI + "/" + primaryKeyValue;
            return getAjaxRequest(url);
        };

        function getCustomFieldsForEdit(tableName, primaryKeyValue) {
            var url = "/api/core/custom-field-view/get-where/1";

            var filters = [];

            filters.push(window.getAjaxColumnFilter("WHERE", "table_name", FilterConditions.IsEqualTo, tableName));
            filters.push(window.getAjaxColumnFilter("AND", "resource_id", FilterConditions.IsEqualTo, primaryKeyValue));

            var data = JSON.stringify(filters);

            return getAjaxRequest(url, "POST", data, false);
        };
    </script>

    <script>
        function createPDFDocument(html, documentName) {
            var url = "/Services/CreateDocument.asmx/CreatePdf";
            var data = appendParameter("", "html", html);
            data = appendParameter(data, "documentName", documentName);
            data = getData(data);

            return getAjax(url, data);
        };

        function createXlsDocument(html, documentName) {
            var url = "/Services/CreateDocument.asmx/CreateXls";
            var data = appendParameter("", "html", html);
            data = appendParameter(data, "documentName", documentName);
            data = getData(data);

            return getAjax(url, data);
        };

        function createDocDocument(html, documentName) {
            var url = "/Services/CreateDocument.asmx/CreateDoc";
            var data = appendParameter("", "html", html);
            data = appendParameter(data, "documentName", documentName);
            data = getData(data);

            return getAjax(url, data);
        };

        function getFileName() {
            var filterName = ($("#DefaultFilterSelect").val() || "");

            if (filterName) {
                filterName += "-";
            };

            return scrudFactory.title + "-" + filterName + stringFormat(Resources.Titles.PageN(), getPageNumber());
        };

        function createPDF() {
            printGridView(reportExportTemplatePath, reportHeaderPath, scrudFactory.title, "ScrudView", date, user, office, '', 2, 0, $("#MarkupHidden"), null, downloadPDF);
        };

        function createXls() {
            printGridView(reportExportTemplatePath, reportHeaderPath, scrudFactory.title, "ScrudView", date, user, office, '', 2, 0, $("#MarkupHidden"), null, downloadXls);
        };

        function createDoc() {
            printGridView(reportExportTemplatePath, reportHeaderPath, scrudFactory.title, "ScrudView", date, user, office, '', 2, 0, $("#MarkupHidden"), null, downloadDoc);
        };

        function print() {
            printGridView(reportExportTemplatePath, reportHeaderPath, scrudFactory.title, "ScrudView", date, user, office, '', 2, 0);
        };

        function downloadXls() {
            var html = $("#MarkupHidden").val();
            var fileName = getFileName() + ".xls";
            var createXlsDocumentAjax = createXlsDocument(html, fileName);

            createXlsDocumentAjax.success(function (msg) {
                startDownload(msg.d);
            });
        };

        function downloadDoc() {
            var html = $("#MarkupHidden").val();
            var fileName = getFileName() + ".doc";
            var createDocDocumentAjax = createDocDocument(html, fileName);

            createDocDocumentAjax.success(function (msg) {
                startDownload(msg.d);
            });
        };


        function downloadPDF() {
            var html = $("#MarkupHidden").val();
            var fileName = getFileName() + ".pdf";
            var createPDFDocumentAjax = createPDFDocument(html, fileName);

            createPDFDocumentAjax.success(function (msg) {
                startDownload(msg.d);
            });
        };

        function startDownload(path) {
            var anchor = $("#DownloadAnchor");
            anchor.attr("href", path);
            anchor[0].click();
        };

    </script>
</div>

<input type="hidden" id="MarkupHidden" />
<a id="DownloadAnchor" download />



<script>
    var filterPopUnder = $("#FilterPopUnder");
    var flagPopUnder = $("#FlagPopUnder");
    var flagButton = $("#FlagButton");
    var filterButton = $("#FilterButton");
    var flagSelect = $("#FlagSelect");
    var updateButton = $("#UpdateButton");
    var verificationPopUnder = $("#VerificationPopUnder");
    var reasonTextArea = $("#ReasonTextArea");
    var approveButton = $("#ApproveButton");
    var rejectButton = $("#RejectButton");

    $(document).on("viewready", function () {
        initializeFlag();

        flagButton.click(function () {
            popUnder(flagPopUnder, flagButton);
        });


        filterButton.click(function () {
            popUnder(filterPopUnder, filterButton);
        });
    });

    function popUnder(div, button) {
        $(".popunder").hide();
        div.removeClass("initially hidden");
        div.fadeIn(500).position({
            my: "left top",
            at: "left bottom",
            of: button
        });
    };



    function displayFlaggedCards() {
        if (!window.flagDefinition) {
            return;
        };

        if (!window.kanbans) {
            return;
        };


        $.each(window.flagDefinition, function (i, v) {
            var card = $('.card[data-key="' + v.ResourceId + '"]');

            if (card.length) {
                var flag = $('<a class="ui red top right attached label" />');
                flag.text(v.FlagTypeName);

                card.find(".content .header").append(flag);

                card.css("background-color", v.BackgroundColor);
                card.css("color", v.ForegroundColor);
            };
        });
    };

    function displayFlaggedRows() {
        $("#ScrudView").find("tbody tr").each(function () {
            var row = $(this);
            var resourceId = row.find("td:nth-child(3)").text();

            var data = Enumerable.From(window.flagDefinition)
                .Where(function (x) { return x.ResourceId === resourceId }).ToArray()[0];

            if (data) {
                row.css("background-color", data.BackgroundColor);
                row.css("color", data.ForegroundColor);
                row.attr("data-flag", data.FlagTypeName);
                row.attr("data-flag-id", data.FlagId);
            };
        });
    };

    function initializeFlag() {
        function getFlagTypes() {
            var url = "/api/core/flag-type/display-fields";
            return getAjaxRequest(url);
        };

        function addFlag(flag) {
            var url = "/api/core/flag/add-or-edit";
            var data = JSON.stringify(flag);
            return getAjaxRequest(url, "PUT", data);
        };

        function deleteFlag(flagId) {
            var url = "/api/core/flag/delete/" + flagId;
            return getAjaxRequest(url, "DELETE");
        };

        if (!flagSelect.find("option").length) {
            var getFlagTypesAjax = getFlagTypes();

            getFlagTypesAjax.success(function (msg) {
                bindSelect(flagSelect, msg, "Key", "Value");
                var options = "<option value='0'>" + Resources.Titles.None() + "</option>";
                options += flagSelect.html();
                flagSelect.html(options);
                flagSelect.dropdown();
            });
        };

        updateButton.unbind("click").click(function () {
            var selecteRows = $("input:checkbox:checked").closest("tr");
            if (selecteRows.length === 0) {
                return;
            };

            selecteRows.each(function (i) {
                var row = $(this);
                var flag = new Object();


                flag.FlagId = (row.attr("data-flag-id") || 0);
                flag.ResourceId = row.find("td:nth-child(3)").text();
                flag.FlagTypeId = parseInt(flagSelect.val());
                flag.Resource = scrudFactory.viewTableName;
                flag.ResourceKey = "";

                var flagAjax;

                if (flag.FlagTypeId) {
                    flagAjax = addFlag(flag);
                } else {
                    flagAjax = deleteFlag(flag.FlagId);
                };


                flagAjax.success(function () {
                    if (i + 1 === selecteRows.length) {
                        if (flag.FlagTypeId) {
                            window.displayMessage("Flag saved.", "success");
                        } else {
                            window.displayMessage("Flag removed.");
                        };

                        loadPageCount(loadGrid);
                    };
                });

                flagAjax.fail(function (xhr) {
                    logAjaxErrorMessage(xhr);
                });
            });
        });


        function getIds() {
            var ids = [];
            $("#ScrudView").find("td:nth-child(3)").each(function () {
                ids.push($(this).text());
            });

            return ids;
        };

        function getFlagView(resource, userId, flagIds) {
            var url = "/api/core/flag-view/get/";
            url += resource + "/";
            url += userId;
            url += "?resourceIds=";
            url += flagIds.join("&resourceIds=");

            return getAjaxRequest(url);
        };

        function displayFlags() {
            var ids = getIds();

            var getFlagViewAjax = getFlagView(scrudFactory.viewTableName, userId, ids);

            getFlagViewAjax.success(function (msg) {
                window.flagDefinition = msg;

                displayFlaggedRows();
                displayFlaggedCards();
            });
        };

        displayFlags();
    };


</script>

<script>
    $(".action.buttons .button").click(function () {
        $(".action.buttons .button").removeClass("active");
        var el = $(this);
        var target = el.attr("data-target");

        if (target) {
            showTarget(target);
        };

        var url = updateQueryString("View", target);
        window.history.pushState({ path: url }, '', url);
    });

    function showTarget(target) {
        $("div[data-target]").hide();
        var targetEl = $('div[data-target="' + target.toLowerCase() + '"]');
        targetEl.removeClass("hidden").fadeIn(500);

        $('a[data-target]').removeClass("active");
        $('a[data-target="' + target + '"]').addClass("active");
    };

    $(document).ready(function () {
        var view = getQueryStringByName("View");
        if (view) {
            showTarget(view);
        };
    });
</script>

<script>
    $(function () {
        $(".kanban.segments").css("width", (($(".segment").length - 1) * 300) + "px").fadeIn(500);
    });

    var kanbanTemplate = '<div id="kanban{KanbanId}" class="ui segment">\
                    <span class="ui teal left large label" data-kanban-id="{KanbanId}" title="{Description}">{KanbanName}</span>\
                    <div class="ui right floated tiny basic icon buttons">\
                        <a title="{AddNewCheckListLocalized}" class="ui basic button" href="javascript:void(0);" onclick="addKanban();"><i class="add icon"></i></a>\
                        <a title="{EditThisCheckListLocalized}" class="ui basic button" href="javascript:void(0);" onclick="editKanban(this);"><i class="edit icon"></i></a>\
                        <a title="{DeleteThisCheckListLocalized}" class="ui basic button" href="javascript:void(0);" onclick="deleteKanban(this);"><i class="delete icon"></i></a>\
                    </div>\
                    <div class="ui clearing padded divider"></div> \
                    <div class="kanban holder"></div> \
                </div>';

    function createKanbanSegment(kanban) {
        var local = kanbanTemplate;
        local = local.replace(/{KanbanId}/g, kanban.KanbanId);
        local = local.replace(/{KanbanName}/g, kanban.KanbanName);
        local = local.replace(/{Description}/g, kanban.Description);
        local = local.replace("{AddNewCheckListLocalized}", "Add New Checlist");
        local = local.replace("{EditThisCheckListLocalized}", "Edit This Checklsit");
        local = local.replace("{DeleteThisCheckListLocalized}", "Delete This Checklist");

        var el = $(local);

        $("#kanban").append(el);
    };

    function createKanbans(kanbans) {
        $("#kanban").html("");

        var kanban = new Object();
        kanban.KanbanId = "0";
        kanban.KanbanName = "Default";
        createKanbanSegment(kanban);

        $.each(kanbans, function (i, kanban) {
            createKanbanSegment(kanban);
        });

        createCards();
    };

    function getKanbans() {
        var url = "/api/core/kanban/get-where/1";

        var filters = [];
        filters.push(getAjaxColumnFilter("WHERE", "object_name", FilterConditions.IsEqualTo, scrudFactory.viewTableName));
        filters.push(getAjaxColumnFilter("WHERE", "user_id", FilterConditions.IsEqualTo, window.userId));

        var data = JSON.stringify(filters);

        return getAjaxRequest(url, "POST", data, false);
    };

    $(document).ready(function () {
        refreshKanbans();
    });

    function refreshKanbans() {
        var getKanbansAjax = getKanbans();

        getKanbansAjax.success(function (msg) {
            window.kanbans = msg;
            createKanbans(msg);
        });
    };

    function addKanban() {
        $("#KanbanForm").modal("show");
    };

    function deleteKanban(el) {
        function ajax(kanbanId) {
            var url = "/api/core/kanban/delete/" + kanbanId;
            return getAjaxRequest(url, "DELETE");
        };

        el = $(el);
        var label = el.parent().parent().find(".label");
        var kanbanId = parseInt(label.attr("data-kanban-id"));

        if (kanbanId) {
            var confirmed = confirmAction();

            if (!confirmed) {
                return;
            };

            var ajaxRequst = ajax(kanbanId);

            ajaxRequst.success(function () {
                refreshKanbans();
            });
        };
    };

    function editKanban(el) {
        el = $(el);
        var label = el.parent().parent().find(".left.label");

        var kanbanId = parseInt(label.attr("data-kanban-id"));
        var kanbanName = label.text();
        var description = label.attr("title");


        if (kanbanId) {
            $("#KanbanIdInputText").val(kanbanId);
            $("#KanbanNameInputText").val(kanbanName);
            $("#KanbanDescriptionTextArea").val(description);

            $("#KanbanForm").modal("show");
        };
    };

    function saveOrUpdateKanban() {
        function addOrEditKanban(k) {
            var url = "/api/core/kanban/add-or-edit";

            var form = [];
            form.push(k);
            form.push(null);

            var data = JSON.stringify(form);
            return getAjaxRequest(url, "PUT", data);
        };

        var kanbanIdInputText = $("#KanbanIdInputText");
        var kanbanNameInputText = $("#KanbanNameInputText");
        var kanbanDescriptionTextArea = $("#KanbanDescriptionTextArea");

        if (isNullOrWhiteSpace(kanbanNameInputText.val())) {
            makeDirty(kanbanNameInputText);
            return;
        };

        removeDirty(kanbanNameInputText);

        var kanban = new Object();
        kanban.KanbanId = (kanbanIdInputText.val() || 0);
        kanban.ObjectName = scrudFactory.viewTableName;
        kanban.UserId = window.userId;
        kanban.KanbanName = kanbanNameInputText.val();
        kanban.Description = kanbanDescriptionTextArea.val();

        var addOrEditKanbanAjax = addOrEditKanban(kanban);

        addOrEditKanbanAjax.success(function () {
            $("#KanbanForm").modal("hide");
            refreshKanbans();
        });
    };


</script>

<script>
    function createCards() {
        function getKanbanDetails(kanbanIds, resourceIds) {
            var url = "/api/core/kanban-detail/get-by-resources/";
            url += "?kanbanIds=";
            url += kanbanIds.join("&kanbanIds=");

            url += "&resourceIds=";
            url += resourceIds.join("&resourceIds=");

            return getAjaxRequest(url);
        };

        if (!window.json) {
            return;
        };

        if (!window.kanbans) {
            return;
        };

        var keyField = (scrudFactory.card.keyField || getIdField());
        var resourceIds = Enumerable.From(window.json).Select(function (employee) { return employee[keyField]; }).ToArray();
        var kanbanIds = Enumerable.From(window.kanbans).Select(function (kanbans) { return kanbans.KanbanId; }).ToArray();

        var getKanbanDetailsAjax = getKanbanDetails(kanbanIds, resourceIds);

        getKanbanDetailsAjax.success(function (msg) {
            $(".kanban.holder").html("");

            $.each(window.json, function (i, v) {
                var key = getCardKey(v);
                var kanbanDetail = (Enumerable.From(msg).Where(function (detail) { return detail.ResourceId.toString() === key.toString() }).ToArray()[0] || new Object());
                createCard(v, key, kanbanDetail);
            });

            makeSortable();
            makeRatable();
            displayFlaggedCards();
        });

    };

    function makeSortable() {
        $(function () {
            $("#kanban .segment .kanban.holder").sortable({
                connectWith: "#kanban .segment .kanban.holder",
                receive: function (event, ui) {
                    var card = $(ui.item[0]);

                    var kanbanDetail = new Object();
                    kanbanDetail.KanbanDetailId = (card.attr("data-kanban-detail-id") || 0);
                    kanbanDetail.KanbanId = parseInt(card.parent().parent().attr("id").replace("kanban", "") || 0);
                    kanbanDetail.Rating = card.find(".rating .active.icon").length;
                    kanbanDetail.ResourceId = card.attr("data-key");

                    if (kanbanDetail.KanbanId) {
                        var addOrEditKanbanDetailAjax = addOrEditKanbanDetail(kanbanDetail);

                        addOrEditKanbanDetailAjax.success(function (msg) {
                            card.attr("data-kanban-detail-id", msg);
                        });
                    } else {
                        if (kanbanDetail.KanbanDetailId) {
                            var deleteKanbanDetailAjax = deleteKanbanDetail(kanbanDetail.KanbanDetailId);

                            deleteKanbanDetailAjax.success(function () {
                                card.removeAttr("data-kanban-detail-id");
                            });
                        };
                    };

                }
            }).disableSelection();
        });
    };

    function makeRatable() {
        $('.ui.rating').rating();

        function updateRating(kanbanDetail) {
            var url = "/api/core/kanban-detail/add-or-edit";

            var form = [];
            form.push(kanbanDetail);
            form.push(null);

            var data = JSON.stringify(form);

            return getAjaxRequest(url, "PUT", data);
        };

        $('.ui.rating i').dblclick(function () {
            var el = $(this);
            var card = el.parent().parent().parent();
            var kanbanDetailId = card.attr("data-kanban-detail-id");

            if (kanbanDetailId) {

                var kanbanDetail = new Object();
                kanbanDetail.KanbanDetailId = kanbanDetailId;
                kanbanDetail.KanbanId = card.closest(".segment").attr("id").replace("kanban", "");
                kanbanDetail.ResourceId = card.attr("data-key");
                kanbanDetail.Rating = el.parent().find("i.active").length;

                updateRating(kanbanDetail);
            };
        });
    };

    function deleteKanbanDetail(kanbanDetailId) {
        var url = "/api/core/kanban-detail/delete/" + kanbanDetailId;

        return getAjaxRequest(url, "DELETE");
    };

    function addOrEditKanbanDetail(kanbanDetail) {
        var url = "/api/core/kanban-detail/add-or-edit";

        var form = [];
        form.push(kanbanDetail);
        form.push(null);

        var data = JSON.stringify(form);

        return getAjaxRequest(url, "PUT", data);
    };

    function getExtraContent(key) {
        var extraContent = $('<div class="extra center content" />');
        var buttons = $('<div class="ui small basic buttons" />');

        if (scrudFactory.viewUrl) {
            var url = scrudFactory.viewUrl.replace("{Key}", key);
            var viewButton = $('<a class="ui basic button" />');
            viewButton.attr("href", url);
            viewButton.text("View");
            buttons.append(viewButton);
        };

        if (scrudFactory.allowEdit) {
            var editButton = $('<a class="ui basic button" href="javascript:void(0);" onclick="editRow(this, true);" />');
            editButton.text("Edit");
            buttons.append(editButton);
        }

        if (scrudFactory.allowDelete) {
            var deleteButton = $('<a class="ui basic button" href="javascript:void(0);" onclick="deleteRow(this, true);" />');
            deleteButton.text("Delete");
            buttons.append(deleteButton);
        };


        extraContent.append(buttons);

        return extraContent;
    };

    function getExtra(kanbanDetail) {
        var extra = $('<div class="extra" />');

        var text = $("<span />");
        text.text("Rating");
        extra.append(text);

        var dataRating = (kanbanDetail.Rating || 0);

        var rating = $('<div class="ui star rating" data-max-rating="5" />');
        rating.attr("data-rating", dataRating);

        extra.append(rating);

        return extra;
    };

    function getClassName() {
        var table = scrudFactory.formTableName;

        if (!table) {
            table = scrudFactory.viewTableName;
        }

        var plural = toProperCase(table.split(".")[1]);
        return plural.singularize();
    };

    function getQualified(dynamic, prefix, suffixes) {
        var qualified = "";

        $.each(suffixes, function (i, v) {
            if (!qualified) {
                var candidate = prefix + v;

                if (dynamic.hasOwnProperty(candidate)) {
                    qualified = candidate;
                    return false;
                };
            };
        });

        return qualified;
    };

    var candidates = {
        primary: ["Code", "Number", "Name"],
        secondary: [
                    "Party", "PartyName", "Item", "ItemName",
                    "NoticeDate", "ApprovedOn", "Reason", "Employee",
                    "EmployeeName", "EmployeeCode", "Office"
        ]
    };

    function getHeaderField(dynamic) {
        var className = getClassName();

        var primary = candidates.primary;
        var qualified = getQualified(dynamic, className, primary);

        if (!qualified) {
            var secondary = candidates.secondary;

            qualified = getQualified(dynamic, "", secondary);
        };

        return qualified;
    };

    function getMetaField(dynamic, headerField) {
        var className = getClassName();

        var primary = Enumerable.From(candidates.primary)
                      .Where(function (x) { return x !== headerField })
                      .ToArray();

        var qualified = getQualified(dynamic, className, primary);

        if (!qualified) {
            var secondary = Enumerable.From(candidates.secondary)
                          .Where(function (x) { return x !== headerField })
                          .ToArray();

            qualified = getQualified(dynamic, "", secondary);
        };

        return qualified;

    };

    function getIdField() {
        var className = getClassName();
        return className + "Id";
    };

    function getCardKey(dynamic) {
        var keyField = (scrudFactory.card.keyField || getIdField());
        return dynamic[keyField];
    };

    function getImageField(entity) {
        var imageField;

        $.each(entity, function (i) {
            if (!imageField) {
                if (i.toLowerCase().indexOf("image") !== -1) {
                    imageField = i;
                };
            };

            if (!imageField) {
                if (i.toLowerCase().indexOf("photo") !== -1) {
                    imageField = i;
                };
            };
        });

        return imageField;
    };

    function getDescriptionField(entity) {
        var candidates = ["Email", "Url", "City", "Phone", "CompanyName", "Currency"];
        return getQualified(entity, "", candidates);
    };

    function createCard(dynamic, key, kanbanDetail) {

        var kanbanId = (kanbanDetail.KanbanId || 0);

        var text;
        var imageField = (scrudFactory.card.image || getImageField(dynamic));
        var headerField = (scrudFactory.card.header || getHeaderField(dynamic));
        var metaField = (scrudFactory.card.meta || getMetaField(dynamic, headerField));
        var descriptionField = (scrudFactory.card.description || getDescriptionField(dynamic));

        var card = $('<div class="ui card" />');
        card.attr("data-kanban-detail-id", kanbanDetail.KanbanDetailId);
        card.attr("data-key", key);

        if (imageField) {
            var src = dynamic[imageField];
            if (src) {
                var div = $('<div class="image" />');
                var img = $("<img />");
                img.attr("src", "/api/core/attachment/document/300/250/" + src);

                div.append(img);
                card.append(div);
            };
        };

        var content = $('<div class="content" />');

        if (headerField) {
            text = dynamic[headerField];
            if (text) {
                var header = $('<div class="header" />');

                header.text(text);
                content.append(header);
            };
        };

        if (metaField) {
            text = dynamic[metaField];
            if (text) {
                var meta = $('<div class="meta" />');

                meta.text(text);
                content.append(meta);
            };
        };

        if (descriptionField) {
            text = dynamic[descriptionField];
            if (text) {
                var description = $('<div class="meta" />');

                description.text(text);
                content.append(description);
            };
        };

        card.append(content);
        card.append(getExtraContent(key));
        card.append(getExtra(kanbanDetail));

        $("#kanban" + kanbanId + " .kanban.holder").append(card);
    };

    function hasVerfication() {
        if (!scrudFactory.formAPI) {
            return false;
        };

        var candidates = ["verification_status_id", "verification_reason"];

        var columns = Enumerable.From(metaDefinition.Columns).Select(function (x) { return x.ColumnName.toString() }).ToArray();
        var result = Enumerable.From(candidates).Except(columns).ToArray();
        return result.length === 0;
    };

    function createVerification() {
        if (!hasVerfication()) {
            return;
        };

        var anchor = $("<a href='javascript:void(0);' id='VerifyButton' class='ui basic button' />");
        anchor.html("Verify");

        anchor.insertAfter(flagButton);

        var verifyButton = $("#VerifyButton");

        verifyButton.click(function () {
            popUnder(verificationPopUnder, verifyButton);
        });
    };

    function getFirstSelection() {
        var selectedRow = $("input:checkbox:checked").closest("tr:first-child");
        if (selectedRow.length === 0) {
            return undefined;
        };

        var selector = "td:nth-child(" + getKeyColumnPosition() + ")";
        var primaryKeyValue = selectedRow.find(selector).text();

        return primaryKeyValue;
    };

    approveButton.click(function () {
        var primaryKey = getFirstSelection();

        if (!hasVerfication() || !primaryKey) {
            return;
        };

        var reason = reasonTextArea.val();
        var verificationStatusId = 2;//2 -> Approved, -3 -> Rejected

        var verifyAjax = verify(primaryKey, verificationStatusId, reason);

        verifyAjax.success(function() {
            displayMessage(Resources.Labels.TaskCompletedSuccessfully(), "success");
        });
    });

    function verify(primaryKey, verificationStatusId, reason) {
        var url = scrudFactory.formAPI;
        url += "/verify/";
        url += primaryKey + "/";
        url += verificationStatusId + "/";
        url += reason;

        return getAjaxRequest(url, "PUT");
    };
</script>